# Flutter FCM Notifications

A production-ready Flutter library for Firebase Cloud Messaging (FCM) that provides persistent notification storage, beautiful iOS-inspired UI, and a one-call setup for both Android and iOS.

---

## Features

- **One-call setup** — `FcmSetupService.initialize()` handles everything: local notifications, iOS foreground options, background handler, foreground listener, and cold-start messages
- **Persistent storage** — Notifications survive app restarts via SharedPreferences
- **Beautiful iOS-inspired UI** — Date-grouped list, unread indicator, pull-to-refresh, filter All/Unread
- **Image support** — Renders notification images inline in the card
- **Deep link / click action** — `onNotificationTap` callback with full `NotificationItem` context
- **Full FCM payload support** — `imageUrl`, `clickAction`, `channelId`, `tag`, `color` diekstrak otomatis
- **Dark theme & i18n** — Preset Indonesia/English/Dark, semua teks bisa dikustomisasi
- **Null-safe & production-ready** — `flutter analyze` bersih, 22 unit tests

---

## Requirements

| Platform | Minimum version |
|----------|----------------|
| Flutter  | ≥ 3.0.0 |
| Dart     | ≥ 3.0.0 |
| Android  | minSdk 21 (Android 5.0) |
| iOS      | 12.0 |

---

## Installation

Tambahkan ke `pubspec.yaml`:

```yaml
dependencies:
  flutter_fcm_notifications: ^1.0.0
  
  # Required peer dependencies
  firebase_core: ^2.24.2
  firebase_messaging: ^14.7.10
  provider: ^6.1.1
```

```bash
flutter pub get
```

---

## Firebase Project Setup

### 1. Buat Firebase Project

1. Buka [Firebase Console](https://console.firebase.google.com)
2. Buat project atau pilih project yang sudah ada
3. Daftarkan Android app dan/atau iOS app

### 2. Generate `firebase_options.dart`

Install FlutterFire CLI lalu jalankan di root project kamu:

```bash
dart pub global activate flutterfire_cli
flutterfire configure
```

Perintah ini otomatis generate file `lib/firebase_options.dart` dengan semua credential yang benar.

### 3. Android — `google-services.json`

1. Download `google-services.json` dari Firebase Console → Project Settings → Android App
2. Taruh di `android/app/google-services.json`
3. Update `android/build.gradle.kts` (root):

```kotlin
plugins {
    id("com.google.gms.google-services") version "4.4.4" apply false
}
```

4. Update `android/app/build.gradle.kts`:

```kotlin
plugins {
    id("com.android.application")
    id("kotlin-android")
    id("dev.flutter.flutter-gradle-plugin")
    id("com.google.gms.google-services")  // ← tambahkan ini
}
```

5. Tambahkan permission di `android/app/src/main/AndroidManifest.xml`:

```xml
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>

<application ...>
    <!-- Default notification channel untuk FCM -->
    <meta-data
        android:name="com.google.firebase.messaging.default_notification_channel_id"
        android:value="high_importance_channel"/>
</application>
```

### 4. iOS — `GoogleService-Info.plist`

1. Download `GoogleService-Info.plist` dari Firebase Console → Project Settings → iOS App
2. Taruh di `ios/Runner/GoogleService-Info.plist` (drag & drop via Xcode supaya ter-bundle dengan benar)
3. Di Xcode: pilih target **Runner** → tab **Signing & Capabilities** → klik **+** → tambahkan:
   - `Push Notifications`
   - `Background Modes` → centang `Remote notifications`

---

## Quick Start

### `main.dart`

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter/material.dart';
import 'package:flutter_fcm_notifications/flutter_fcm_notifications.dart';
import 'package:provider/provider.dart';
import 'firebase_options.dart'; // generated by flutterfire configure

// ⚠️ Harus top-level function, tidak boleh di dalam class
@pragma('vm:entry-point')
Future<void> _backgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
  // Tampilkan local notification saat app di background/terminated
  await FcmSetupService.showLocalNotification(message);
}

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // Buat dan inisialisasi manager
  final manager = NotificationManager(
    config: NotificationConfig.indonesian, // atau .english, atau custom
  );
  await manager.initialize();

  // Setup seluruh FCM stack dengan satu pemanggilan
  await FcmSetupService.initialize(
    manager,
    backgroundHandler: _backgroundHandler,
  );

  runApp(
    // Expose manager ke seluruh widget tree via Provider
    ChangeNotifierProvider.value(
      value: manager,
      child: const MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'My App',
      home: const HomePage(),
    );
  }
}
```

### Tampilkan notification bell + badge

```dart
Consumer<NotificationManager>(
  builder: (context, manager, _) {
    return Stack(
      children: [
        IconButton(
          icon: const Icon(Icons.notifications),
          onPressed: () => Navigator.push(
            context,
            MaterialPageRoute(
              builder: (_) => NotificationScreen(manager: manager),
            ),
          ),
        ),
        if (manager.unreadCount > 0)
          Positioned(
            right: 8,
            top: 8,
            child: Container(
              padding: const EdgeInsets.all(4),
              decoration: const BoxDecoration(
                color: Colors.red,
                shape: BoxShape.circle,
              ),
              child: Text(
                '${manager.unreadCount}',
                style: const TextStyle(color: Colors.white, fontSize: 10),
              ),
            ),
          ),
      ],
    );
  },
)
```

---

## FcmSetupService

`FcmSetupService.initialize()` adalah cara yang direkomendasikan — satu fungsi untuk setup semua sekaligus.

```dart
await FcmSetupService.initialize(
  manager,

  // Handler saat app di background / terminated
  backgroundHandler: _backgroundHandler,

  // Android notification channel (opsional, ada default)
  channelId: 'high_importance_channel',
  channelName: 'High Importance Notifications',
  channelDescription: 'Used for important app notifications.',

  // Icon notifikasi di status bar Android
  androidIconName: '@mipmap/ic_launcher',

  // Callback tambahan saat ada pesan foreground (opsional)
  onForegroundMessage: (message) {
    debugPrint('Pesan masuk: ${message.notification?.title}');
  },

  // Callback saat user tap notifikasi (dari background/terminated)
  onMessageOpenedApp: (message) {
    // Navigasi ke halaman tertentu
    navigatorKey.currentState?.pushNamed('/notifications');
  },

  // Callback saat user tap local notification
  onNotificationResponse: (response) {
    debugPrint('Local notif di-tap, payload: ${response.payload}');
  },
);
```

### Tampilkan local notification secara manual

Bisa dipakai di background handler atau di mana saja:

```dart
await FcmSetupService.showLocalNotification(message);
```

---

## NotificationConfig

Kustomisasi tampilan dan perilaku notification screen.

### Preset siap pakai

```dart
NotificationConfig.indonesian   // Bahasa Indonesia, light mode
NotificationConfig.english       // English, light mode
NotificationConfig.dark          // Dark theme
```

### Custom config

```dart
final config = NotificationConfig(
  // Warna
  primaryColor: const Color(0xFF007AFF),
  backgroundColor: const Color(0xFFF2F2F7),
  cardBackgroundColor: Colors.white,
  unreadCardBackgroundColor: const Color(0xFFF8F8F8),
  titleTextColor: Colors.black,
  bodyTextColor: const Color(0xFF6B6B70),
  unreadIndicatorColor: const Color(0xFF007AFF),

  // Teks (lokalisasi)
  locale: 'id_ID',
  appBarTitle: 'Notifikasi',
  markAllReadText: 'Tandai Semua Dibaca',
  allNotificationsText: 'Semua',
  unreadFilterText: 'Belum Dibaca',
  noNotificationsTitle: 'Belum Ada Notifikasi',
  noNotificationsSubtitle: 'Notifikasi baru akan muncul di sini',
  todayLabel: 'Hari ini',
  yesterdayLabel: 'Kemarin',

  // Perilaku
  maxNotifications: 50,         // Maksimal notifikasi tersimpan
  enableHapticFeedback: true,   // Getar saat tap
  enablePullToRefresh: true,    // Tarik untuk refresh
  cardBorderRadius: 12.0,       // Sudut kartu

  // Deep link — dipanggil setelah user tap notifikasi
  onNotificationTap: (notification) {
    // notification.clickAction berisi nilai dari data['click_action']
    final route = notification.clickAction ?? '/notifications';
    GoRouter.of(context).go(route);
  },
);
```

### Kombinasi preset + override

```dart
NotificationConfig.dark.copyWith(
  primaryColor: Colors.purple,
  locale: 'en_US',
  onNotificationTap: (n) => context.go(n.clickAction ?? '/'),
)
```

### Semua property yang bisa dikustomisasi

| Property | Type | Default |
|---|---|---|
| `primaryColor` | `Color` | `0xFF007AFF` |
| `backgroundColor` | `Color` | `0xFFF2F2F7` |
| `cardBackgroundColor` | `Color` | `Colors.white` |
| `unreadCardBackgroundColor` | `Color` | `0xFFF8F8F8` |
| `titleTextColor` | `Color` | `Colors.black` |
| `bodyTextColor` | `Color` | `0xFF6B6B70` |
| `secondaryTextColor` | `Color` | `0xFF8E8E93` |
| `unreadIndicatorColor` | `Color` | `0xFF007AFF` |
| `dateHeaderColor` | `Color` | `0xFF8E8E93` |
| `locale` | `String` | `'id_ID'` |
| `maxNotifications` | `int` | `50` |
| `appBarTitle` | `String` | `'Notifikasi'` |
| `markAllReadText` | `String` | `'Tandai Sudah Dibaca'` |
| `allNotificationsText` | `String` | `'Semua Notifikasi'` |
| `unreadFilterText` | `String` | `'Belum Dibaca'` |
| `noNotificationsTitle` | `String` | `'Tidak Ada Notifikasi'` |
| `noNotificationsSubtitle` | `String` | `'Notifikasi baru akan muncul di sini'` |
| `todayLabel` | `String` | `'Hari ini'` |
| `yesterdayLabel` | `String` | `'Kemarin'` |
| `enableHapticFeedback` | `bool` | `true` |
| `enablePullToRefresh` | `bool` | `true` |
| `cardBorderRadius` | `double` | `12.0` |
| `emptyStateIcon` | `IconData` | `Icons.notifications_active` |
| `emptyStateIconSize` | `double` | `40.0` |
| `onNotificationTap` | `void Function(NotificationItem)?` | `null` |

---

## NotificationManager API

`NotificationManager` adalah `ChangeNotifier` — bisa dipakai dengan `Provider`, `Consumer`, atau `context.watch`.

### Properties

```dart
manager.notifications     // List<NotificationItem> — semua notifikasi, terbaru di atas
manager.unreadCount       // int — jumlah notifikasi belum dibaca
manager.isInitialized     // bool — apakah manager sudah siap
```

### Methods

```dart
await manager.initialize();                    // Wajib dipanggil sekali sebelum pakai
await manager.addNotification(remoteMessage);  // Tambah notifikasi dari FCM
await manager.markAsRead(messageId);           // Tandai satu notifikasi sudah dibaca
await manager.markAllAsRead();                 // Tandai semua sudah dibaca
await manager.removeNotification(messageId);   // Hapus satu notifikasi
await manager.clearAll();                      // Hapus semua notifikasi
```

---

## NotificationItem

Model notifikasi yang dibuat otomatis dari `RemoteMessage`. Semua field di-ekstrak otomatis dari payload FCM.

```dart
notification.title        // String   — judul notifikasi
notification.body         // String   — isi notifikasi
notification.timestamp    // DateTime — waktu diterima
notification.messageId    // String   — ID unik (UUID fallback jika Firebase tidak kirim)
notification.isRead       // bool     — status baca
notification.data         // Map?     — full data payload dari FCM
notification.imageUrl     // String?  — URL gambar (dari android.imageUrl atau data['image'])
notification.clickAction  // String?  — deep link route (dari data['click_action'])
notification.channelId    // String?  — Android channel ID
notification.tag          // String?  — Android notification tag
notification.color        // String?  — Android accent color (hex, e.g. '#FF0000')
```

---

## FCM Payload yang Di-support

Library ini otomatis membaca semua field berikut dari FCM payload:

### Contoh FCM payload dari backend

```json
{
  "to": "DEVICE_FCM_TOKEN",
  "notification": {
    "title": "Pesanan Diterima",
    "body": "Pesanan #1234 sedang diproses.",
    "image": "https://example.com/promo.jpg"
  },
  "data": {
    "click_action": "/orders/1234",
    "order_id": "1234",
    "image": "https://example.com/promo.jpg"
  }
}
```

| Field dari FCM | Tersimpan di `NotificationItem` |
|---|---|
| `notification.title` | `title` |
| `notification.body` | `body` |
| `notification.android.imageUrl` atau `data['image']` | `imageUrl` |
| `data['click_action']` | `clickAction` |
| `notification.android.channelId` | `channelId` |
| `notification.android.tag` | `tag` |
| `notification.android.color` | `color` |
| semua `data` fields | `data` (Map) |

---

## Deep Link / Navigasi

Gunakan `onNotificationTap` di `NotificationConfig` untuk navigasi setelah user tap:

```dart
// Dengan GoRouter
NotificationConfig(
  onNotificationTap: (notification) {
    final route = notification.clickAction ?? '/notifications';
    context.go(route);
  },
)

// Dengan Navigator
NotificationConfig(
  onNotificationTap: (notification) {
    Navigator.pushNamed(context, notification.clickAction ?? '/notifications');
  },
)

// Dengan custom logic berdasarkan data payload
NotificationConfig(
  onNotificationTap: (notification) {
    final orderId = notification.data?['order_id'];
    if (orderId != null) {
      context.go('/orders/$orderId');
    } else {
      context.go('/notifications');
    }
  },
)
```

> Mark as read dipanggil otomatis **sebelum** callback `onNotificationTap` dijalankan.

---

## Kirim Test Notification

### Dari Firebase Console

1. Buka Firebase Console → **Cloud Messaging** → **Send your first message**
2. Isi Title dan Body
3. Pilih target app
4. Klik **Send test message** → masukkan FCM token dari device

### Dari backend (Node.js + Firebase Admin SDK)

```javascript
const admin = require('firebase-admin');

await admin.messaging().send({
  token: 'DEVICE_FCM_TOKEN',
  notification: {
    title: 'Pesanan Diterima',
    body: 'Pesanan #1234 sedang diproses.',
    imageUrl: 'https://example.com/promo.jpg',  // opsional
  },
  data: {
    click_action: '/orders/1234',   // deep link
    order_id: '1234',               // custom data
  },
  android: {
    notification: {
      channelId: 'high_importance_channel',
      priority: 'high',
    },
  },
  apns: {
    payload: {
      aps: { sound: 'default' },
    },
  },
});
```

---

## Advanced: Setup Manual (tanpa FcmSetupService)

Kalau kamu ingin kontrol penuh tanpa pakai `FcmSetupService`:

```dart
// Foreground messages
FirebaseMessaging.onMessage.listen((message) {
  manager.addNotification(message);
});

// Tap dari background
FirebaseMessaging.onMessageOpenedApp.listen((message) {
  manager.addNotification(message);
});

// Cold start (app terminated)
final initialMessage = await FirebaseMessaging.instance.getInitialMessage();
if (initialMessage != null) {
  await manager.addNotification(initialMessage);
}

// Background handler
FirebaseMessaging.onBackgroundMessage(_backgroundHandler);
```

---

## License

MIT License — lihat file [LICENSE](LICENSE) untuk detail.

## Contributing

Contributions welcome! Silakan buka issue atau submit pull request di GitHub.


## Features

- Beautiful, iOS-inspired notification UI
- Persistent notification storage using SharedPreferences
- Automatic read/unread status tracking
- Date-grouped notifications (Today, Yesterday, etc.)
- Pull-to-refresh support
- Filter notifications (All/Unread)
- Haptic feedback
- Fully customizable colors, text, and locale
- Dark theme support
- Clean architecture with ChangeNotifier
- Null-safe and production-ready

## Installation

Add this to your package's `pubspec.yaml` file:

```yaml
dependencies:
  flutter_fcm_notifications: ^1.0.0
```

Then run:

```bash
flutter pub get
```

## Firebase Setup

### Android

1. Add your `google-services.json` to `android/app/`
2. Update `android/build.gradle`:

```gradle
buildscript {
    dependencies {
        classpath 'com.google.gms:google-services:4.4.0'
    }
}
```

3. Update `android/app/build.gradle`:

```gradle
apply plugin: 'com.google.gms.google-services'

android {
    defaultConfig {
        minSdkVersion 21
    }
}
```

4. Add to `AndroidManifest.xml`:

```xml
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
```

### iOS

1. Add your `GoogleService-Info.plist` to `ios/Runner/`
2. Enable Push Notifications in Xcode capabilities
3. Add to `ios/Runner/Info.plist`:

```xml
<key>UIBackgroundModes</key>
<array>
    <string>remote-notification</string>
</array>
```

## Usage

### Basic Setup

```dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_fcm_notifications/flutter_fcm_notifications.dart';
import 'package:provider/provider.dart';

// Background message handler
@pragma('vm:entry-point')
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp();
  print("Background message: ${message.messageId}");
}

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp();
  
  // Set background message handler
  FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);
  
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => NotificationManager()..initialize(),
      child: MaterialApp(
        title: 'FCM Notifications',
        home: HomePage(),
      ),
    );
  }
}

class HomePage extends StatefulWidget {
  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  @override
  void initState() {
    super.initState();
    _setupFCM();
  }

  Future<void> _setupFCM() async {
    final messaging = FirebaseMessaging.instance;
    final manager = context.read<NotificationManager>();
    
    // Request permission
    await messaging.requestPermission(
      alert: true,
      badge: true,
      sound: true,
    );
    
    // Get FCM token
    final token = await messaging.getToken();
    print('FCM Token: $token');
    
    // Handle foreground messages
    FirebaseMessaging.onMessage.listen((RemoteMessage message) {
      manager.addNotification(message);
    });
    
    // Handle message taps
    FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
      manager.addNotification(message);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Home'),
        actions: [
          Consumer<NotificationManager>(
            builder: (context, manager, _) {
              return Stack(
                children: [
                  IconButton(
                    icon: Icon(Icons.notifications),
                    onPressed: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                          builder: (_) => NotificationScreen(
                            manager: manager,
                          ),
                        ),
                      );
                    },
                  ),
                  if (manager.unreadCount > 0)
                    Positioned(
                      right: 8,
                      top: 8,
                      child: Container(
                        padding: EdgeInsets.all(4),
                        decoration: BoxDecoration(
                          color: Colors.red,
                          shape: BoxShape.circle,
                        ),
                        child: Text(
                          '${manager.unreadCount}',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 10,
                          ),
                        ),
                      ),
                    ),
                ],
              );
            },
          ),
        ],
      ),
      body: Center(
        child: Text('Send a test notification from Firebase Console'),
      ),
    );
  }
}
```

## Customization

### Custom Configuration

```dart
final customConfig = NotificationConfig(
  primaryColor: Colors.blue,
  backgroundColor: Colors.white,
  locale: 'en_US',
  maxNotifications: 100,
  appBarTitle: 'My Notifications',
  markAllReadText: 'Mark All as Read',
  enableHapticFeedback: true,
  enablePullToRefresh: true,
);

NotificationScreen(
  manager: notificationManager,
  config: customConfig,
)
```

### Predefined Configurations

```dart
// English
NotificationConfig.english

// Indonesian
NotificationConfig.indonesian

// Dark Theme
NotificationConfig.dark

// Custom combination
NotificationConfig.english.copyWith(
  primaryColor: Colors.purple,
  backgroundColor: Colors.black,
)
```

### Customizable Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| primaryColor | Color | Color(0xFF007AFF) | Primary accent color |
| backgroundColor | Color | Color(0xFFF2F2F7) | Screen background |
| cardBackgroundColor | Color | Colors.white | Read notification card |
| unreadCardBackgroundColor | Color | Color(0xFFF8F8F8) | Unread notification card |
| titleTextColor | Color | Colors.black | Notification title |
| bodyTextColor | Color | Color(0xFF6B6B70) | Notification body |
| secondaryTextColor | Color | Color(0xFF8E8E93) | Time and headers |
| unreadIndicatorColor | Color | Color(0xFF007AFF) | Unread dot |
| locale | String | 'id_ID' | Date formatting locale |
| maxNotifications | int | 50 | Maximum stored notifications |
| markAllReadText | String | 'Tandai Sudah Dibaca' | Button text |
| allNotificationsText | String | 'Semua Notifikasi' | Filter option |
| unreadFilterText | String | 'Belum Dibaca' | Filter option |
| noNotificationsTitle | String | 'Tidak Ada Notifikasi' | Empty state title |
| noNotificationsSubtitle | String | 'Notifikasi baru akan muncul di sini' | Empty state subtitle |
| todayLabel | String | 'Hari ini' | Today label |
| yesterdayLabel | String | 'Kemarin' | Yesterday label |
| appBarTitle | String | 'Notifications' | App bar title |
| enableHapticFeedback | bool | true | Haptic feedback on tap |
| enablePullToRefresh | bool | true | Pull to refresh |
| cardBorderRadius | double | 12.0 | Card corner radius |
| emptyStateIcon | IconData | Icons.notifications_active | Empty state icon |

## NotificationManager API

### Properties

```dart
manager.notifications          // List of all notifications
manager.unreadCount           // Number of unread notifications
manager.readStatus            // Map of message IDs to read status
manager.isInitialized         // Whether manager is ready
```

### Methods

```dart
await manager.initialize()                    // Initialize and load data
await manager.addNotification(message)        // Add new notification
await manager.markAsRead(messageId)           // Mark one as read
await manager.markAllAsRead()                 // Mark all as read
await manager.clearAll()                      // Delete all notifications
await manager.removeNotification(messageId)   // Remove specific notification
```

## Testing

### Send Test Notification from Firebase Console

1. Go to Firebase Console > Cloud Messaging
2. Click "Send your first message"
3. Enter notification title and text
4. Select your app
5. Send test message to your FCM token

### Send from your backend

```javascript
const admin = require('firebase-admin');

await admin.messaging().send({
  token: 'DEVICE_FCM_TOKEN',
  notification: {
    title: 'Hello',
    body: 'Test notification',
  },
  data: {
    customKey: 'customValue',
  },
});
```

## Requirements

- Flutter >=3.0.0
- Dart >=3.0.0
- iOS >=12.0
- Android minSdkVersion 21

## License

MIT License - see LICENSE file for details

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

## Support

For issues and questions, please file an issue on GitHub.

